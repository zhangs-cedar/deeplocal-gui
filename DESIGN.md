# 架构设计文档

## 整体架构

```
项目中心 (Project Center)
├── 项目列表
│   ├── 项目1
│   │   ├── 工作区1
│   │   │   ├── 数据管理
│   │   │   └── 实验管理
│   │   ├── 工作区2
│   │   │   ├── 数据管理
│   │   │   └── 实验管理
│   │   └── ...
│   ├── 项目2
│   └── ...
```

## 层级结构

### 1. 项目中心 (ProjectCenter)
**职责：**
- 管理所有项目
- 显示项目列表
- 创建/删除/选择项目

**界面布局：**
```
┌─────────────────────────────────────┐
│  项目中心                           │
├──────────┬──────────────────────────┤
│          │                          │
│ 项目列表 │  内容区域                │
│          │  - 项目详情              │
│ - 项目1  │  - 工作区列表            │
│ - 项目2  │  - 快速操作              │
│          │                          │
│ [+新建]  │                          │
└──────────┴──────────────────────────┘
```

### 2. 项目 (Project)
**职责：**
- 管理多个工作区
- 项目元信息（名称、描述、创建时间）
- 工作区列表展示

**数据结构：**
```python
Project:
    - id: str
    - name: str
    - desc: str
    - created_at: datetime
    - workspaces: List[Workspace]
```

### 3. 工作区 (Workspace)
**职责：**
- 包含数据管理和实验管理
- 工作区切换
- 工作区配置

**界面布局：**
```
┌─────────────────────────────────────┐
│  项目: XXX  |  工作区: [工作区1 ▼]  │
├──────────┬──────────────────────────┤
│          │                          │
│ 功能导航 │  内容区域                │
│          │                          │
│ [数据管理]│  - 数据管理界面         │
│ [实验管理]│  - 实验管理界面         │
│          │                          │
│          │                          │
└──────────┴──────────────────────────┘
```

### 4. 数据管理 (DataManagement)
**职责：**
- 数据集上传
- 数据集列表
- 数据集预览
- 数据集操作（删除、导出等）

**功能模块：**
- 数据集上传：选择目录/文件
- 数据集列表：显示所有数据集
- 数据集详情：预览、统计信息
- 数据集操作：删除、导出、分割

### 5. 实验管理 (ExperimentManagement)
**职责：**
- 实验创建
- 实验列表
- 实验训练
- 实验监控
- 实验结果

**功能模块：**
- 实验创建：选择数据集、配置参数
- 实验列表：显示所有实验
- 训练监控：进度、日志、指标
- 结果查看：模型、评估报告

## 数据流

```
用户操作
  ↓
项目中心 (选择项目)
  ↓
项目界面 (选择工作区)
  ↓
工作区界面 (选择功能)
  ↓
数据管理 / 实验管理
  ↓
执行操作
```

## 界面导航

### 主窗口结构
```
MainWindow
├── ProjectCenterWidget (项目中心)
│   ├── ProjectListWidget (左侧项目列表)
│   └── ProjectDetailWidget (右侧项目详情)
│
└── WorkspaceWidget (工作区界面)
    ├── WorkspaceSelector (工作区选择器)
    ├── DataManagementWidget (数据管理)
    └── ExperimentManagementWidget (实验管理)
```

## 核心类设计

### 1. MainWindow
- 主窗口容器
- 管理项目中心和工作区切换
- 无 pubsub，直接方法调用

### 2. ProjectCenterWidget
- 项目列表展示
- 项目创建/删除
- 项目选择

### 3. ProjectWidget
- 项目详情展示
- 工作区列表
- 工作区创建/删除

### 4. WorkspaceWidget
- 工作区内容容器
- 功能标签切换（数据管理/实验管理）

### 5. DataManagementWidget
- 数据集上传
- 数据集列表
- 数据集操作

### 6. ExperimentManagementWidget
- 实验创建
- 实验列表
- 训练监控

## 状态管理

### 当前状态
```python
current_project: Project | None
current_workspace: Workspace | None
current_view: "data" | "experiment"
```

### 状态切换
- 项目切换 → 重置工作区 → 显示默认工作区
- 工作区切换 → 保持当前视图（数据/实验）
- 视图切换 → 保持当前工作区

## 数据存储

### 项目数据
```
projects/
├── project_1/
│   ├── project.json (项目元信息)
│   └── workspaces/
│       ├── workspace_1/
│       │   ├── workspace.json
│       │   ├── datasets/
│       │   └── experiments/
│       └── workspace_2/
└── project_2/
```

## 交互流程

### 创建项目
1. 点击"新建项目"
2. 输入项目名称、描述
3. 创建默认工作区
4. 自动切换到新项目

### 创建工作区
1. 在项目详情中点击"新建工作区"
2. 输入工作区名称
3. 添加到工作区列表
4. 可选：切换到新工作区

### 上传数据
1. 切换到数据管理视图
2. 点击"上传数据集"
3. 选择数据目录
4. 显示上传进度
5. 添加到数据集列表

### 创建实验
1. 切换到实验管理视图
2. 点击"新建实验"
3. 选择数据集
4. 配置训练参数
5. 开始训练

## Linus 风格原则

1. **直接调用**：组件间通过 parent 引用直接调用方法
2. **无消息总线**：不使用 pubsub，避免间接调用
3. **简洁界面**：使用系统默认样式，不自定义样式
4. **清晰结构**：每个组件职责单一，边界清晰
5. **最小依赖**：只使用 PyQt6，不引入额外框架

## 文件结构

```
app.py                    # 主入口
main_window.py            # 主窗口
project_center.py         # 项目中心
project_widget.py         # 项目界面
workspace_widget.py       # 工作区界面
data_management.py        # 数据管理
experiment_management.py  # 实验管理
models.py                 # 数据模型（Project, Workspace）
utils.py                  # 工具函数
```

## 详细界面设计

### 主窗口布局

```
┌─────────────────────────────────────────────────────────┐
│  深度学习训练工具                                        │
├──────────┬───────────────────────────────────────────────┤
│          │                                               │
│ 项目列表 │  内容区域（动态切换）                        │
│          │                                               │
│ [项目1]  │  - 项目中心视图                              │
│ [项目2]  │  - 工作区视图                                │
│          │                                               │
│ [+新建]  │                                               │
│          │                                               │
└──────────┴───────────────────────────────────────────────┘
```

### 项目中心视图

```
┌─────────────────────────────────────────────────────────┐
│  项目中心                                                │
├───────────────────────────────────────────────────────────┤
│                                                           │
│  项目详情                                                │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 项目名称: XXX                                       │ │
│  │ 项目描述: ...                                       │ │
│  │ 创建时间: 2024-01-01                                │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                           │
│  工作区列表                                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ [工作区1]  [工作区2]  [+新建工作区]                │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                           │
│  [进入工作区]                                            │
│                                                           │
└───────────────────────────────────────────────────────────┘
```

### 工作区视图

```
┌─────────────────────────────────────────────────────────┐
│  项目: XXX  |  工作区: [工作区1 ▼]  [+新建工作区]      │
├──────────┬───────────────────────────────────────────────┤
│          │                                               │
│ 功能标签 │  内容区域                                     │
│          │                                               │
│ [数据管理]│  - 数据集列表                                │
│ [实验管理]│  - 实验列表                                  │
│          │                                               │
│          │                                               │
└──────────┴───────────────────────────────────────────────┘
```

### 数据管理界面

```
┌─────────────────────────────────────────────────────────┐
│  数据管理                                                │
├───────────────────────────────────────────────────────────┤
│  [上传数据集]                                            │
│                                                           │
│  数据集列表                                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 数据集1  [查看] [删除]                              │ │
│  │ 数据集2  [查看] [删除]                              │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                           │
│  数据集详情（选中后显示）                                │
│  - 数据集路径                                            │
│  - 数据统计                                              │
│  - 预览                                                  │
│                                                           │
└───────────────────────────────────────────────────────────┘
```

### 实验管理界面

```
┌─────────────────────────────────────────────────────────┐
│  实验管理                                                │
├───────────────────────────────────────────────────────────┤
│  [新建实验]                                              │
│                                                           │
│  实验列表                                                │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 实验1  [训练中] [查看] [删除]                        │ │
│  │ 实验2  [已完成] [查看] [删除]                        │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                           │
│  实验详情（选中后显示）                                  │
│  - 训练参数                                              │
│  - 训练进度                                              │
│  - 训练日志                                              │
│  - 结果指标                                              │
│                                                           │
└───────────────────────────────────────────────────────────┘
```

## 组件通信设计

### 直接调用链

```
MainWindow
  ├── show_project_center()  # 显示项目中心
  └── show_workspace(project, workspace)  # 显示工作区

ProjectCenterWidget
  ├── on_project_selected(project)  # 直接调用 MainWindow.show_workspace()
  └── on_create_project()  # 创建项目后直接刷新列表

WorkspaceWidget
  ├── on_workspace_changed(workspace)  # 切换工作区
  └── on_view_changed(view)  # 切换视图（数据/实验）

DataManagementWidget
  └── refresh_datasets()  # 刷新数据集列表

ExperimentManagementWidget
  └── refresh_experiments()  # 刷新实验列表
```

### 无 pubsub 设计

所有组件通过 parent 引用直接调用：
- `self.parent().method()` - 调用父组件方法
- `self.main_window.method()` - 调用主窗口方法
- 传递引用而非消息

## 数据模型

### Project 模型
```python
class Project:
    id: str
    name: str
    desc: str
    created_at: datetime
    path: Path  # 项目存储路径
    workspaces: List[Workspace]
    
    def add_workspace(workspace)
    def remove_workspace(workspace_id)
    def get_workspace(workspace_id)
```

### Workspace 模型
```python
class Workspace:
    id: str
    name: str
    project_id: str
    created_at: datetime
    path: Path  # 工作区存储路径
    datasets: List[Dataset]
    experiments: List[Experiment]
    
    def add_dataset(dataset)
    def add_experiment(experiment)
```

### Dataset 模型
```python
class Dataset:
    id: str
    name: str
    workspace_id: str
    path: Path
    type: str  # classification, detection, etc.
    created_at: datetime
    stats: dict  # 数据统计信息
```

### Experiment 模型
```python
class Experiment:
    id: str
    name: str
    workspace_id: str
    dataset_id: str
    status: str  # pending, running, completed, failed
    config: dict  # 训练配置
    results: dict  # 训练结果
    created_at: datetime
```

## 操作流程设计

### 完整工作流

1. **启动应用**
   - 显示项目中心
   - 加载项目列表

2. **创建项目**
   - 输入项目信息
   - 创建项目目录
   - 创建默认工作区
   - 切换到项目视图

3. **进入工作区**
   - 选择工作区
   - 显示工作区界面
   - 默认显示数据管理

4. **上传数据**
   - 选择数据目录
   - 验证数据格式
   - 复制到工作区
   - 更新数据集列表

5. **创建实验**
   - 选择数据集
   - 配置参数
   - 创建实验
   - 开始训练

6. **监控训练**
   - 显示训练进度
   - 实时日志
   - 指标图表
   - 训练完成通知

## 关键技术点

### 1. 状态管理
- 主窗口维护当前状态
- 组件通过方法参数传递状态
- 无全局状态，避免耦合

### 2. 数据持久化
- JSON 文件存储元信息
- 文件系统存储实际数据
- 简单直接，易于调试

### 3. 异步操作
- 数据上传：QThread
- 训练执行：QThread
- UI 不阻塞

### 4. 错误处理
- 简单直接：try/except
- 用户提示：QMessageBox
- 日志记录：print（Linus 风格）

## 设计原则总结

1. **简洁**：界面简洁，功能清晰
2. **直接**：组件间直接调用，无中间层
3. **高效**：最小化代码，最大化功能
4. **清晰**：结构清晰，职责单一
5. **实用**：满足需求，不过度设计

